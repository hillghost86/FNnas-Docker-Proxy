# Nginx HTTP 代理配置
# 使用 HTTP 协议，避免 SSL 证书配置
# 只对 docker.fnnas.com 添加认证 header

upstream docker_fnnas {
    server docker.fnnas.com:443;
    keepalive 32;
}

# 设置代理主机和端口（外部访问地址）
map $http_host $proxy_host_port {
    default $http_host;
    "" $host:15000;
}

server {
    listen 15000;
    server_name docker.fnnas.com localhost;
    
    access_log ${ACCESS_LOG_CONFIG};
    error_log ${ERROR_LOG_CONFIG};
    
    # 允许大文件
    client_max_body_size 0;
    
    # 超时设置
    proxy_connect_timeout 300;
    proxy_send_timeout 300;
    proxy_read_timeout 300;
    
    # 禁用缓冲
    proxy_request_buffering off;
    proxy_buffering off;
    proxy_http_version 1.1;
    
    # 通用代理 header
    proxy_set_header Host docker.fnnas.com;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;  # 告诉后端这是 HTTPS 请求
    proxy_set_header X-Forwarded-Host docker.fnnas.com;
    proxy_set_header Connection "";
    
    # 确保传递原始 header
    proxy_pass_request_headers on;
    
    # SSL 相关（代理到 HTTPS 后端）
    proxy_ssl_verify off;
    proxy_ssl_server_name on;
    proxy_ssl_name docker.fnnas.com;
    
    # 飞牛 NAS 认证 header（从环境变量读取）
    proxy_set_header X-Meta-Token "${META_TOKEN}";
    proxy_set_header X-Meta-Sign "${META_SIGN}";
    
    # 隐藏原始的 WWW-Authenticate header（包含原始地址）
    proxy_hide_header WWW-Authenticate;
    
    # 重写重定向（将 HTTPS 重定向改为 HTTP）
    proxy_redirect https://docker.fnnas.com/ http://$proxy_host_port/;
    proxy_redirect http://docker.fnnas.com/ http://$proxy_host_port/;
    proxy_redirect https://docker.fnnas.com:80/ http://$proxy_host_port/;
    proxy_redirect http://docker.fnnas.com:80/ http://$proxy_host_port/;
    proxy_redirect https://docker.fnnas.com:443/ http://$proxy_host_port/;
    proxy_redirect http://docker.fnnas.com:443/ http://$proxy_host_port/;
    
    # 健康检查端点
    location = /health {
        access_log off;
        return 200 "OK\n";
        add_header Content-Type text/plain;
    }
    
    # Harbor API 代理（用于搜索镜像）
    location /api/v2.0/ {
        proxy_pass https://docker.fnnas.com/api/v2.0/;
        
        # 添加认证 headers
        proxy_set_header X-Meta-Token "${META_TOKEN}";
        proxy_set_header X-Meta-Sign "${META_SIGN}";
        proxy_set_header Host docker.fnnas.com;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-Host docker.fnnas.com;
        proxy_set_header Connection "";
        
        # SSL 相关
        proxy_ssl_verify off;
        proxy_ssl_server_name on;
        proxy_ssl_name docker.fnnas.com;
        
        # 超时设置
        proxy_connect_timeout 30;
        proxy_send_timeout 30;
        proxy_read_timeout 30;
        
        # CORS 支持（允许前端跨域访问）
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
        
        if ($request_method = OPTIONS) {
            return 204;
        }
    }
    
    # 静态文件服务（搜索页面）
    location = /index.html {
        root /usr/share/nginx/html;
        add_header Content-Type text/html;
    }
    
    # 根路径：返回搜索页面（Docker 客户端通常不会访问根路径）
    location = / {
        root /usr/share/nginx/html;
        try_files /index.html =404;
        add_header Content-Type text/html;
    }
    
    # Docker Registry 服务端点（token 认证）
    location /service/ {
        proxy_pass https://docker.fnnas.com/service/;
        
        # 添加认证 headers（token 服务也需要认证）
        proxy_set_header X-Meta-Token "${META_TOKEN}";
        proxy_set_header X-Meta-Sign "${META_SIGN}";
        proxy_set_header Host docker.fnnas.com;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-Host docker.fnnas.com;
        proxy_set_header Connection "";
        
        # SSL 相关
        proxy_ssl_verify off;
        proxy_ssl_server_name on;
        proxy_ssl_name docker.fnnas.com;
        
        proxy_redirect https://docker.fnnas.com/ http://$proxy_host_port/;
        proxy_redirect http://docker.fnnas.com/ http://$proxy_host_port/;
        proxy_redirect https://docker.fnnas.com:80/ http://$proxy_host_port/;
        proxy_redirect http://docker.fnnas.com:80/ http://$proxy_host_port/;
        proxy_redirect https://docker.fnnas.com:443/ http://$proxy_host_port/;
        proxy_redirect http://docker.fnnas.com:443/ http://$proxy_host_port/;
    }
    
    # Docker Registry v2 API
    location /v2/ {
        proxy_pass https://docker.fnnas.com/v2/;
        
        # 隐藏原始的 WWW-Authenticate header
        proxy_hide_header WWW-Authenticate;
        
        # 添加新的 WWW-Authenticate header，使用代理地址
        add_header WWW-Authenticate 'Bearer realm="http://$proxy_host_port/service/token",service="harbor-registry"' always;
        
        proxy_redirect https://docker.fnnas.com/ http://$proxy_host_port/;
        proxy_redirect http://docker.fnnas.com/ http://$proxy_host_port/;
        proxy_redirect https://docker.fnnas.com:80/ http://$proxy_host_port/;
        proxy_redirect http://docker.fnnas.com:80/ http://$proxy_host_port/;
        proxy_redirect https://docker.fnnas.com:443/ http://$proxy_host_port/;
        proxy_redirect http://docker.fnnas.com:443/ http://$proxy_host_port/;
    }
    
    # 处理其他路径（代理到 Docker Registry）
    location / {
        proxy_pass https://docker.fnnas.com/;
        
        # 隐藏原始的 WWW-Authenticate header
        proxy_hide_header WWW-Authenticate;
        
        # 添加新的 WWW-Authenticate header，使用代理地址
        add_header WWW-Authenticate 'Bearer realm="http://$proxy_host_port/service/token",service="harbor-registry"' always;
        
        proxy_redirect https://docker.fnnas.com/ http://$proxy_host_port/;
        proxy_redirect http://docker.fnnas.com/ http://$proxy_host_port/;
        proxy_redirect https://docker.fnnas.com:80/ http://$proxy_host_port/;
        proxy_redirect http://docker.fnnas.com:80/ http://$proxy_host_port/;
        proxy_redirect https://docker.fnnas.com:443/ http://$proxy_host_port/;
        proxy_redirect http://docker.fnnas.com:443/ http://$proxy_host_port/;
    }
}

